<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mermug Tracker - Test Runner</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #3498db;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .test-section h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .test-pass {
            background-color: #d4edda;
            border-left-color: #28a745;
            color: #155724;
        }
        .test-fail {
            background-color: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        .test-skip {
            background-color: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        .summary {
            background-color: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            text-align: center;
            font-weight: bold;
        }
        .run-tests-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 20px;
        }
        .run-tests-btn:hover {
            background-color: #2980b9;
        }
        .test-details {
            font-family: monospace;
            font-size: 12px;
            margin-top: 5px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>üß™ Mermug Tracker Test Suite</h1>
            <p>Simple JavaScript testing framework for the marine vessel tracking dashboard</p>
            <button class="run-tests-btn" onclick="runAllTests()">Run All Tests</button>
        </div>

        <div id="test-results">
            <div class="summary" id="summary">
                Click "Run All Tests" to start testing
            </div>
        </div>
    </div>

    <script>
        // Simple test framework
        class TestFramework {
            constructor() {
                this.tests = [];
                this.results = { passed: 0, failed: 0, skipped: 0 };
            }

            describe(name, testFunction) {
                this.tests.push({ name, testFunction, type: 'describe' });
            }

            it(name, testFunction) {
                this.tests.push({ name, testFunction, type: 'it' });
            }

            expect(actual) {
                return {
                    toBe: (expected) => {
                        if (actual === expected) return true;
                        throw new Error(`Expected ${actual} to be ${expected}`);
                    },
                    toContain: (expected) => {
                        if (actual.includes(expected)) return true;
                        throw new Error(`Expected ${actual} to contain ${expected}`);
                    },
                    toBeInTheDocument: () => {
                        if (actual && actual.nodeType) return true;
                        throw new Error(`Expected element to be in document`);
                    },
                    toHaveClass: (className) => {
                        if (actual.classList && actual.classList.contains(className)) return true;
                        throw new Error(`Expected element to have class ${className}`);
                    },
                    toHaveAttribute: (attr, value) => {
                        if (actual.hasAttribute && actual.hasAttribute(attr)) {
                            if (value === undefined || actual.getAttribute(attr) === value) return true;
                        }
                        throw new Error(`Expected element to have attribute ${attr}${value ? `="${value}"` : ''}`);
                    },
                    toBeCloseTo: (expected, precision = 2) => {
                        const tolerance = Math.pow(10, -precision) / 2;
                        if (Math.abs(actual - expected) < tolerance) return true;
                        throw new Error(`Expected ${actual} to be close to ${expected} (within ${tolerance})`);
                    }
                };
            }

            runTests() {
                this.results = { passed: 0, failed: 0, skipped: 0 };
                const resultsDiv = document.getElementById('test-results');
                resultsDiv.innerHTML = '';

                let currentDescribe = '';
                
                this.tests.forEach(test => {
                    if (test.type === 'describe') {
                        currentDescribe = test.name;
                        const sectionDiv = document.createElement('div');
                        sectionDiv.className = 'test-section';
                        sectionDiv.innerHTML = `<h3>${test.name}</h3>`;
                        resultsDiv.appendChild(sectionDiv);
                        test.sectionDiv = sectionDiv;
                    } else if (test.type === 'it') {
                        const resultDiv = document.createElement('div');
                        resultDiv.className = 'test-result';
                        
                        try {
                            test.testFunction();
                            resultDiv.classList.add('test-pass');
                            resultDiv.innerHTML = `
                                <strong>‚úÖ PASS:</strong> ${test.name}
                                <div class="test-details">Test completed successfully</div>
                            `;
                            this.results.passed++;
                        } catch (error) {
                            resultDiv.classList.add('test-fail');
                            resultDiv.innerHTML = `
                                <strong>‚ùå FAIL:</strong> ${test.name}
                                <div class="test-details">Error: ${error.message}</div>
                            `;
                            this.results.failed++;
                        }
                        
                        if (currentDescribe && test.sectionDiv) {
                            test.sectionDiv.appendChild(resultDiv);
                        } else {
                            resultsDiv.appendChild(resultDiv);
                        }
                    }
                });

                this.updateSummary();
            }

            updateSummary() {
                const summaryDiv = document.getElementById('summary');
                const total = this.results.passed + this.results.failed + this.results.skipped;
                summaryDiv.innerHTML = `
                    <strong>Test Summary:</strong> ${this.results.passed} passed, ${this.results.failed} failed, ${this.results.skipped} skipped (${total} total)
                `;
            }
        }

        // Create global test framework
        const test = new TestFramework();
        const { describe, it, expect } = test;

        // Mock data for testing
        const mockSignalKData = {
            navigation: {
                position: {
                    value: { latitude: 37.806, longitude: -122.465 },
                    timestamp: "2024-01-15T10:30:00Z"
                },
                courseOverGroundTrue: { value: 0.785398 }, // 45 degrees
                speedOverGround: { value: 5.144444 }, // 10 knots
                speedThroughWater: { value: 5.144444 }, // 10 knots
                trip: { log: { value: 18520 } }, // 10 nautical miles
                log: { value: 185200 } // 100 nautical miles
            },
            environment: {
                wind: {
                    speedTrue: { value: 5.144444 }, // 10 knots
                    angleTrue: { value: 0.785398 }, // 45 degrees
                    angleApparent: { value: 0.523599 } // 30 degrees
                },
                water: { temperature: { value: 288.15 } } // 15¬∞C
            },
            electrical: {
                batteries: {
                    house: {
                        voltage: { value: 12.5 },
                        current: { value: 2.0 },
                        power: { value: 25.0 },
                        capacity: {
                            stateOfCharge: { value: 0.8 },
                            timeRemaining: { value: 36000 }
                        }
                    }
                }
            },
            design: {
                length: { value: { overall: 13.0 } }, // 42.7 feet
                beam: { value: 4.24 }, // 13.9 feet
                draft: { value: { maximum: 1.89 } } // 6.2 feet
            }
        };

        const mockPolarData = [
            { twa: 0, speeds: [2, 3, 4, 5, 6, 7, 8, 9, 10] },
            { twa: 30, speeds: [3, 4, 5, 6, 7, 8, 9, 10, 11] },
            { twa: 60, speeds: [4, 5, 6, 7, 8, 9, 10, 11, 12] },
            { twa: 90, speeds: [5, 6, 7, 8, 9, 10, 11, 12, 13] },
            { twa: 120, speeds: [4, 5, 6, 7, 8, 9, 10, 11, 12] },
            { twa: 150, speeds: [3, 4, 5, 6, 7, 8, 9, 10, 11] },
            { twa: 180, speeds: [2, 3, 4, 5, 6, 7, 8, 9, 10] }
        ];

        // Helper functions
        function createMockDOM() {
            document.body.innerHTML = `
                <div id="updateBanner">
                    <div style="display: flex; justify-content: center; align-items: center;">
                        <div style="text-align: center;">
                            <span id="dataStatus">Loading data...</span> | <span id="updateTime">--</span>
                        </div>
                    </div>
                </div>
                <button id="darkModeToggle" class="floating-dark-mode-btn">üåô Dark Mode</button>
                <div class="container">
                    <div class="info-logo-row">
                        <img src="mermug.png" alt="Mermug Logo" class="logo-side" />
                        <div class="map-container" style="flex: 1; margin: 0;">
                            <div id="mapTitle" style="font-weight: bold; font-size: 1.1em; text-align: center; margin-bottom: 10px; color: var(--text-primary);">Loading location...</div>
                            <div id="map"></div>
                        </div>
                    </div>
                    <div class="info-panel" id="info-panel" style="margin: 20px;">
                        <div style="font-weight: bold; font-size: 1.1em; margin-bottom: 15px; text-align: left; color: var(--text-primary);">Instrument Dashboard</div>
                        <div class="data-grid" id="data-grid"></div>
                    </div>
                    <div class="info-panel" style="margin: 20px;">
                        <div id="tideHeader" style="text-align:left; padding-top: 10px; font-weight: bold; font-size: 1.1em;"></div>
                        <canvas id="tideChart"></canvas>
                    </div>
                    <div class="info-panel" style="margin: 20px;">
                        <div style="font-weight: bold; font-size: 1.1em; margin-bottom: 15px; text-align: left; color: var(--text-primary);">Polar Performance</div>
                        <div class="polar-performance-grid" id="polar-performance-grid">
                            <div style="display: flex; flex-direction: column; gap: 15px;">
                                <div style="background: var(--bg-quaternary); padding: 15px; border-radius: 8px;">
                                    <div style="font-weight: bold; margin-bottom: 10px; color: var(--text-primary);">Current Performance</div>
                                    <div id="polar-performance" style="font-size: 0.9em;">
                                        <div>Loading polar data...</div>
                                    </div>
                                </div>
                                <div style="background: var(--bg-quaternary); padding: 15px; border-radius: 8px;">
                                    <div style="font-weight: bold; margin-bottom: 10px; color: var(--text-primary);">VMG Analysis</div>
                                    <div id="vmg-analysis" style="font-size: 0.9em;">
                                        <div>Calculating VMG...</div>
                                    </div>
                                </div>
                            </div>
                            <div style="background: var(--bg-quaternary); padding: 15px; border-radius: 8px;">
                                <div style="font-weight: bold; margin-bottom: 10px; color: var(--text-primary);">Polar Chart</div>
                                <div class="polar-chart-container" style="position: relative; height: 600px; width: 100%;">
                                    <canvas id="polarChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getCurrentTheme() {
            return document.documentElement.getAttribute('data-theme') || 'light';
        }

        // Test suites
        describe('Unit Conversions', () => {
            it('should convert radians to degrees correctly', () => {
                const radiansToDegrees = (rad) => (rad * 180 / Math.PI);
                
                expect(radiansToDegrees(0)).toBe(0);
                expect(radiansToDegrees(Math.PI / 2)).toBe(90);
                expect(radiansToDegrees(Math.PI)).toBe(180);
                expect(radiansToDegrees(Math.PI * 2)).toBe(360);
            });

            it('should convert m/s to knots correctly', () => {
                const msToKnots = (ms) => (ms * 1.94384);
                
                expect(msToKnots(1)).toBeCloseTo(1.94384, 5);
                expect(msToKnots(5.144444)).toBeCloseTo(10, 2); // 10 knots
                expect(msToKnots(0)).toBe(0);
            });

            it('should convert Kelvin to Fahrenheit correctly', () => {
                const kelvinToFahrenheit = (k) => ((k - 273.15) * 9/5 + 32);
                
                expect(kelvinToFahrenheit(273.15)).toBeCloseTo(32, 1); // Freezing
                expect(kelvinToFahrenheit(288.15)).toBeCloseTo(59, 1); // 15¬∞C
                expect(kelvinToFahrenheit(373.15)).toBeCloseTo(212, 1); // Boiling
            });
        });

        describe('Polar Performance Calculations', () => {
            it('should calculate VMG correctly', () => {
                const calculateVMG = (twa, bsp, tws) => {
                    const angleRad = (twa * Math.PI) / 180;
                    return bsp * Math.cos(angleRad);
                };
                
                expect(calculateVMG(0, 10, 10)).toBeCloseTo(10, 2); // Running downwind
                expect(calculateVMG(90, 10, 10)).toBeCloseTo(0, 2); // Beam reach
                expect(calculateVMG(180, 10, 10)).toBeCloseTo(-10, 2); // Beating upwind
            });

            it('should find polar speed for given conditions', () => {
                const getPolarSpeed = (twa, tws) => {
                    if (!mockPolarData) return 0;
                    
                    // Find closest wind speed (simplified for test)
                    const windSpeeds = [4, 6, 8, 10, 12, 14, 16, 20, 24];
                    let speedIndex = 0;
                    for (let i = 0; i < windSpeeds.length; i++) {
                        if (tws <= windSpeeds[i]) {
                            speedIndex = i;
                            break;
                        }
                    }
                    if (speedIndex === 0) speedIndex = 1;
                    
                    // Find closest TWA
                    let closestAngle = mockPolarData[0];
                    let minDiff = Math.abs(twa - mockPolarData[0].twa);
                    
                    for (const angle of mockPolarData) {
                        const diff = Math.abs(twa - angle.twa);
                        if (diff < minDiff) {
                            minDiff = diff;
                            closestAngle = angle;
                        }
                    }
                    
                    return closestAngle.speeds[speedIndex - 1];
                };
                
                expect(getPolarSpeed(90, 10)).toBe(9); // Beam reach at 10 knots wind
                expect(getPolarSpeed(0, 8)).toBe(4); // Running at 8 knots wind
                expect(getPolarSpeed(180, 12)).toBe(8); // Beating at 12 knots wind
            });
        });

        describe('SignalK Data Processing', () => {
            it('should extract navigation data correctly', () => {
                const nav = mockSignalKData.navigation;
                
                expect(nav.position.value.latitude).toBe(37.806);
                expect(nav.position.value.longitude).toBe(-122.465);
                expect(nav.courseOverGroundTrue.value).toBeCloseTo(0.785398, 6); // 45 degrees
                expect(nav.speedOverGround.value).toBeCloseTo(5.144444, 6); // 10 knots
            });

            it('should extract environmental data correctly', () => {
                const env = mockSignalKData.environment;
                
                expect(env.wind.speedTrue.value).toBeCloseTo(5.144444, 6); // 10 knots
                expect(env.wind.angleTrue.value).toBeCloseTo(0.785398, 6); // 45 degrees
                expect(env.water.temperature.value).toBe(288.15); // 15¬∞C
            });

            it('should extract electrical data correctly', () => {
                const elec = mockSignalKData.electrical;
                
                expect(elec.batteries.house.voltage.value).toBe(12.5);
                expect(elec.batteries.house.current.value).toBe(2.0);
                expect(elec.batteries.house.power.value).toBe(25.0);
                expect(elec.batteries.house.capacity.stateOfCharge.value).toBe(0.8);
            });
        });

        describe('Data Validation', () => {
            it('should handle missing data gracefully', () => {
                const safeGet = (obj, path, defaultValue = 'N/A') => {
                    return path.split('.').reduce((current, key) => {
                        return current && current[key] !== undefined ? current[key] : defaultValue;
                    }, obj);
                };
                
                const incompleteData = {
                    navigation: {
                        position: { value: { latitude: 37.806 } }
                        // Missing longitude
                    }
                };
                
                expect(safeGet(incompleteData, 'navigation.position.value.latitude')).toBe(37.806);
                expect(safeGet(incompleteData, 'navigation.position.value.longitude')).toBe('N/A');
                expect(safeGet(incompleteData, 'nonexistent.path')).toBe('N/A');
            });

            it('should validate coordinate ranges', () => {
                const isValidLatitude = (lat) => lat >= -90 && lat <= 90;
                const isValidLongitude = (lon) => lon >= -180 && lon <= 180;
                
                expect(isValidLatitude(37.806)).toBe(true);
                expect(isValidLatitude(91)).toBe(false);
                expect(isValidLatitude(-91)).toBe(false);
                
                expect(isValidLongitude(-122.465)).toBe(true);
                expect(isValidLongitude(181)).toBe(false);
                expect(isValidLongitude(-181)).toBe(false);
            });
        });

        describe('DOM Elements', () => {
            beforeEach(() => {
                createMockDOM();
            });

            it('should have required DOM elements', () => {
                expect(document.getElementById('data-grid')).toBeInTheDocument();
                expect(document.getElementById('mapTitle')).toBeInTheDocument();
                expect(document.getElementById('tideChart')).toBeInTheDocument();
                expect(document.getElementById('polarChart')).toBeInTheDocument();
                expect(document.getElementById('darkModeToggle')).toBeInTheDocument();
            });

            it('should have proper CSS classes', () => {
                expect(document.querySelector('.container')).toHaveClass('container');
                expect(document.querySelector('.info-panel')).toHaveClass('info-panel');
                expect(document.querySelector('.data-grid')).toHaveClass('data-grid');
                expect(document.getElementById('darkModeToggle')).toHaveClass('floating-dark-mode-btn');
            });

            it('should have proper alt text for images', () => {
                const logo = document.querySelector('img');
                expect(logo).toHaveAttribute('alt', 'Mermug Logo');
            });
        });

        describe('Theme Functionality', () => {
            beforeEach(() => {
                createMockDOM();
                document.documentElement.setAttribute('data-theme', 'light');
            });

            it('should initialize with light theme by default', () => {
                expect(getCurrentTheme()).toBe('light');
            });

            it('should have dark mode toggle button', () => {
                const button = document.getElementById('darkModeToggle');
                expect(button).toBeInTheDocument();
                expect(button.textContent).toContain('Dark Mode');
            });
        });

        // Global function to run all tests
        function runAllTests() {
            test.runTests();
        }

        // Auto-run tests when page loads
        window.addEventListener('load', () => {
            // Don't auto-run, let user click button
        });
    </script>
</body>
</html> 